<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Retry Payment</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const options = {
        key: "<%= process.env.RAZORPAY_KEY_ID %>",
        amount: "<%= amount %>", // in paise
        currency: "INR",
        name: "Tiny Beats",
        description: "Retry Order Payment",
        order_id: "<%= razorpayOrderId %>",
        handler: async function (response) {
          try {
            const verifyRes = await fetch("/order/verifyPayment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                addressId: "<%= addressId %>", 
                paymentMethod: "Online"
              })
            });

            const result = await verifyRes.json();
            if (result.success) {
              window.location.href = "/confirmation";
            } else {
              window.location.href = "/paymentFailure";
            }
          } catch (err) {
            console.error("Verification error:", err);
            window.location.href = "/paymentFailure";
          }
        },
        prefill: {
          email: "<%= user.email %>",
          contact: "<%= user.phone %>",
        },
        theme: {
          color: "#3399cc",
        },
        modal: {
          ondismiss: function () {
            window.location.href = "/paymentFailure";
          }
        }
      };

      const rzp = new Razorpay(options);
      rzp.on("payment.failed", function () {
        window.location.href = "/paymentFailure";
      });

      rzp.open();
    });
  </script>
</body>
</html>
